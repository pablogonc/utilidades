//para recargarlos cambios de las librearias click derecho index update modified files
/*
 * main.c
 *
 *  Created on: 5 ago. 2021
 *      Author: utnso
 */

#include <utils/connection/connection.h>
#include <utils/globals.h>
#include <stdio.h>
#include <semaphore.h>
#include <readline/readline.h>
#include <stdlib.h>

#include <readline/readline.h>
sem_t* sockets_sem;

void suma(int socket){
	int a = connection_recive_int(socket);

	int b = connection_recive_int(socket);

	printf("La suma es : %d",(a+b));
}

void resta(int socket){
	int a = connection_recive_int(socket);

	int b = connection_recive_int(socket);

	printf("La resta es : %d",(a-b));
}

void mensaje(int socket){
	char* a = connection_recive_int(socket);

	int b = connection_recive_int(socket);

	printf("mensaje: %s",a);
}

void listenner(void* arg){
	int clientSock = *(int*)arg;
	sem_post(sockets_sem); //libera la espera del server para estar seguro de que no se sobreescriba la variable arg
	printf("cliente conectado: %d \n",clientSock);

	int operacion=0;
	int connectionStatus=1;
	char* message;

	connectionStatus = connection_recive_check(clientSock);

	while(connectionStatus != -1){


		operacion = connection_recive_int(clientSock);
		switch(operacion){
			case OP_SUMA:
				break;
			case OP_RESTA:
				break;
			case OP_MENSAJE:
				break;

		}
		printf("OPERACION : '%d' \n",operacion);

		operacion= connection_recive_int(clientSock);
		printf("NUMERO: '%d' \n",operacion);

		message= connection_recive_string(clientSock);
		printf("MENSAJE: '%s' \n",message);


		operacion = connection_recive_int(clientSock);
		printf("numeroloco : '%d' \n",operacion);

		connectionStatus = connection_recive_check(clientSock);
	}

	printf("conexion perdida con cliente: %d\n",clientSock);
	connection_close(clientSock);
}





int main(void){
	sockets_sem = (sem_t*) malloc(sizeof(sem_t));
	sem_init(sockets_sem,1,0);

	printf("iniciando servidor \n");

	int serverStatus = connection_start_server("127.0.0.1","4449",listenner,sockets_sem);

	if(serverStatus<0){
		connection_server_error(serverStatus);
	}

	readline("presione enter para salir");

	return 1;

}
